name: Check Attestation
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - '**.csv'
      - '**.ver'
      - 'registry/**'
permissions:
  id-token: write
  contents: write
  attestations: write
jobs:
  release-pki:
    uses: 0mniteck/.pki/.github/workflows/immutable.yml@5f81d45eed7d1428395badf76a90cce469942e62 # v0.0.2
  immutable-rel:
    needs: release-pki
    permissions:
      id-token: write
      contents: read
      attestations: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install gh CLI
        run: sudo apt-get -qq update && sudo apt-get -qq install gh
      - name: Authenticate with GitHub CLI
        run: echo "${{ github.token }}" | gh auth login --with-token || exit 1
      - name: Run gh Attestation
        run: |
          for I in $GITHUB_WORKSPACE/registry/* $GITHUB_WORKSPACE/*; do
            gh attestation verify $I --repo 0mniteck/.pki || exit 1;
            echo "$I Attested"
          done;
